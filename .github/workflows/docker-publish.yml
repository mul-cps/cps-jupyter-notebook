# name: Docker

# # This workflow uses actions that are not certified by GitHub.
# # They are provided by a third-party and are governed by
# # separate terms of service, privacy policy, and support
# # documentation.

# on:
#   #schedule:
#   #  - cron: '25 20 * * *'
#   push:
#     branches: [ "main" ]
#     # Publish semver tags as releases.
#     tags: [ 'v*.*.*' ]
#   pull_request:
#     branches: [ "main" ]

# env:
#   # Use docker.io for Docker Hub if empty
#   REGISTRY: ghcr.io
#   # github.repository as <account>/<repo>
#   IMAGE_NAME: ${{ github.repository }}


# jobs:
  
#   build:
#     runs-on: ubuntu-latest
#     permissions:
#       contents: read
#       packages: write
#       # This is used to complete the identity challenge
#       # with sigstore/fulcio when running outside of PRs.
#       id-token: write

#     steps:
#       - name: Checkout repository
#         uses: actions/checkout@v6

#       # Install the cosign tool except on PR
#       # https://github.com/sigstore/cosign-installer
#       - name: Install cosign
#         if: github.event_name != 'pull_request'
#         uses: sigstore/cosign-installer@faadad0cce49287aee09b3a48701e75088a2c6ad # v4.0.0
#         with:
#           cosign-release: 'v2.1.1'

#       # Set up BuildKit Docker container builder to be able to build
#       # multi-platform images and export cache
#       # https://github.com/docker/setup-buildx-action
#       - name: Set up Docker Buildx
#         uses: docker/setup-buildx-action@e468171a9de216ec08956ac3ada2f0791b6bd435 # v3.11.1

#       #Login against a Docker registry except on PR
#       #https://github.com/docker/login-action
#       - name: Log into registry ${{ env.REGISTRY }}
#         if: github.event_name != 'pull_request'
#         uses: docker/login-action@5e57cd118135c172c3672efd75eb46360885c0ef # v3.6.0
#         with:
#           registry: ${{ env.REGISTRY }}
#           username: ${{ github.actor }}
#           password: ${{ github.token }}
#           #password: ${{ secrets.GHCR_PAT }}
          
#       # - name: 'Login to GitHub Container Registry'
#       #   uses: docker/login-action@v3
#       #   with:
#       #     registry: ghcr.io
#       #     username: ${{github.actor}}
#       #     password: ${{secrets.GHCR_PAT}}

#       # Extract metadata (tags, labels) for Docker
#       # https://github.com/docker/metadata-action
#       - name: Extract Docker metadata
#         id: meta
#         uses: docker/metadata-action@c299e40c65443455700f0fdfc63efafe5b349051 # v5.10.0
#         with:
#           images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}

#       # Build and push Docker image with Buildx (don't push on PR)
#       # https://github.com/docker/build-push-action
#       - name: Build and push Docker image
#         id: build-and-push
#         uses: docker/build-push-action@263435318d21b8e681c14492fe198d362a7d2c83 # v6.18.0
#         with:
#           context: ./docker
#           push: ${{ github.event_name != 'pull_request' }}
#           tags: ${{ steps.meta.outputs.tags }}
#           labels: ${{ steps.meta.outputs.labels }}
#           cache-from: type=gha
#           cache-to: type=gha,mode=max
#           secrets: |
#             "root_password=${{ secrets.CPS_ROOT_PASSWORD }}"
          
#       - name: Install Cosign
#         uses: sigstore/cosign-installer@v4.0.0
#       - name: Check install!
#         run: cosign version

#       # Sign the resulting Docker image digest except on PRs.
#       # This will only write to the public Rekor transparency log when the Docker
#       # repository is public to avoid leaking data.  If you would like to publish
#       # transparency data even for private images, pass --force to cosign below.
#       # https://github.com/sigstore/cosign
#       - name: Sign the published Docker image
#         if: ${{ github.event_name != 'pull_request' }}
#         env:
#           # https://docs.github.com/en/actions/security-guides/security-hardening-for-github-actions#using-an-intermediate-environment-variable
#           TAGS: ${{ steps.meta.outputs.tags }}
#           DIGEST: ${{ steps.build-and-push.outputs.digest }}
#         # This step uses the identity token to provision an ephemeral certificate
#         # against the sigstore community Fulcio instance.
#         run: echo "${TAGS}" | xargs -I {} cosign sign --yes {}@${DIGEST}

name: Build & Publish ML Variants

on:
  push:
    branches: [ main ]
    tags:
      - "v*.*.*"
  pull_request:
    branches: [ main ]

jobs:
  build-and-push:
    runs-on: ubuntu-latest

    permissions:
      contents: read
      packages: write
      id-token: write

    strategy:
      fail-fast: false
      matrix:
        variant:
          - name: pytorch-code
            dockerfile: docker/Dockerfile.pytorch-code
            suffix: pytorch-code
          - name: tf-code
            dockerfile: docker/Dockerfile.tf-code
            suffix: tf-code
          - name: desktop-ros2
            dockerfile: docker/Dockerfile.desktop-ros2
            suffix: desktop-ros2
          - name: standard-cpu
            dockerfile: docker/Dockerfile
            suffix: standard-cpu
    env:
      IMAGE_NAME: cps-jupyter-notebook

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Free up disk space on runner
        run: |
          echo "Initial disk usage:"
          df -h

          echo "Removing large preinstalled SDKs..."
          sudo rm -rf /usr/local/lib/android || true
          sudo rm -rf /usr/share/dotnet || true
          sudo rm -rf /opt/ghc || true
          sudo rm -rf /opt/hostedtoolcache || true

          echo "Cleaning docker images and buildx cache..."
          docker system prune -af || true
          docker builder prune -af || true

          echo "Disk usage after cleanup:"
          df -h

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata (tags, labels)
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: |
            ghcr.io/${{ github.repository_owner }}/${{ env.IMAGE_NAME }}
          tags: |
            type=raw,value=latest-${{ matrix.variant.suffix }},enable=${{ startsWith(github.ref, 'refs/heads/main') }}
            type=ref,event=branch,suffix=-${{ matrix.variant.suffix }}
            type=ref,event=tag,suffix=-${{ matrix.variant.suffix }}
            type=sha,suffix=-${{ matrix.variant.suffix }}
          labels: |
            org.opencontainers.image.source=${{ github.server_url }}/${{ github.repository }}
            org.opencontainers.image.revision=${{ github.sha }}

      - name: Build and push
        uses: docker/build-push-action@v6
        with:
          context: ./docker
          file: ${{ matrix.variant.dockerfile }}
          push: ${{ github.event_name != 'pull_request' }}
          platforms: |
            linux/amd64
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          # If you want to build with secrets for admin/root passwords like the base images:
          # secrets: |
          #   "admin_password=${{ secrets.CPS_JUPYTER_ADMIN_PASSWORD }}"
          #   "root_password=${{ secrets.CPS_JUPYTER_ROOT_PASSWORD }}"
