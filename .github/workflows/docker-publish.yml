name: Build & Publish ML Variants

on:
  push:
    branches: [ main ]
    tags:
      - "v*.*.*"
    paths:
      - 'docker/**'
      - '.github/workflows/docker-publish.yml'
  pull_request:
    branches: [ main ]
    paths:
      - 'docker/**'
      - '.github/workflows/docker-publish.yml'

jobs:
  check-changes:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Check for changes
        uses: dorny/paths-filter@v3
        id: changes
        with:
          filters: |
            workflow: .github/workflows/docker-publish.yml
            pytorch_code: docker/Dockerfile.pytorch-code
            tf_code: docker/Dockerfile.tf-code
            desktop_ros2: docker/Dockerfile.desktop-ros2
            comfyui: docker/Dockerfile.comfyui
            standard_cpu: docker/Dockerfile
            common:
              - 'docker/**'
              - '!docker/Dockerfile*'

      - name: Set matrix
        id: set-matrix
        run: |
          # Initialize empty array
          VARIANTS="[]"

          # Helper function to add variant
          add_variant() {
            local name=$1
            local dockerfile=$2
            local suffix=$3
            # Use jq to append object to array
            VARIANTS=$(echo "$VARIANTS" | jq --arg name "$name" --arg dockerfile "$dockerfile" --arg suffix "$suffix" \
              '. + [{"name": $name, "dockerfile": $dockerfile, "suffix": $suffix}]')
          }

          # Check if we need to build everything (common files or workflow changed)
          if [ "${{ steps.changes.outputs.common }}" == "true" ] || [ "${{ steps.changes.outputs.workflow }}" == "true" ]; then
            echo "Common files or workflow changed. Building all variants."
            add_variant "pytorch-code" "docker/Dockerfile.pytorch-code" "pytorch-code"
            add_variant "tf-code" "docker/Dockerfile.tf-code" "tf-code"
            add_variant "desktop-ros2" "docker/Dockerfile.desktop-ros2" "desktop-ros2"
            add_variant "comfyui" "docker/Dockerfile.comfyui" "comfyui"
            add_variant "standard-cpu" "docker/Dockerfile" "standard-cpu"
          else
            # Check individual changes
            if [ "${{ steps.changes.outputs.pytorch_code }}" == "true" ]; then
              add_variant "pytorch-code" "docker/Dockerfile.pytorch-code" "pytorch-code"
            fi
            if [ "${{ steps.changes.outputs.tf_code }}" == "true" ]; then
              add_variant "tf-code" "docker/Dockerfile.tf-code" "tf-code"
            fi
            if [ "${{ steps.changes.outputs.desktop_ros2 }}" == "true" ]; then
              add_variant "desktop-ros2" "docker/Dockerfile.desktop-ros2" "desktop-ros2"
            fi
            if [ "${{ steps.changes.outputs.comfyui }}" == "true" ]; then
              add_variant "comfyui" "docker/Dockerfile.comfyui" "comfyui"
            fi
            if [ "${{ steps.changes.outputs.standard_cpu }}" == "true" ]; then
              add_variant "standard-cpu" "docker/Dockerfile" "standard-cpu"
            fi
          fi

          # Compact JSON to single line just in case
          VARIANTS=$(echo "$VARIANTS" | jq -c '.')
          echo "Generated matrix: $VARIANTS"
          echo "matrix={\"variant\": $VARIANTS}" >> $GITHUB_OUTPUT

  build-and-push:
    needs: check-changes
    if: ${{ fromJson(needs.check-changes.outputs.matrix).variant[0] != null }}
    runs-on: ubuntu-latest

    permissions:
      contents: read
      packages: write
      id-token: write

    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.check-changes.outputs.matrix) }}
    
    env:
      IMAGE_NAME: cps-jupyter-notebook

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Free up disk space on runner
        run: |
          echo "Initial disk usage:"
          df -h

          echo "Removing large preinstalled SDKs..."
          sudo rm -rf /usr/local/lib/android || true
          sudo rm -rf /usr/share/dotnet || true
          sudo rm -rf /usr/share/swift || true
          sudo rm -rf /opt/ghc || true
          sudo rm -rf /usr/local/.ghtl || true
          sudo rm -rf /opt/hostedtoolcache/CodeQL || true

          echo "Removing swap file..."
          sudo swapoff -a
          sudo rm -f /mnt/swapfile

          echo "Cleaning docker system..."
          docker system prune -af || true
          docker builder prune -af || true

          echo "Disk usage after cleanup:"
          df -h

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata (tags, labels)
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: |
            ghcr.io/${{ github.repository_owner }}/${{ env.IMAGE_NAME }}
          tags: |
            type=raw,value=latest-${{ matrix.variant.suffix }},enable=${{ startsWith(github.ref, 'refs/heads/main') }}
            type=ref,event=branch,suffix=-${{ matrix.variant.suffix }}
            type=ref,event=tag,suffix=-${{ matrix.variant.suffix }}
            type=sha,suffix=-${{ matrix.variant.suffix }}
          labels: |
            org.opencontainers.image.source=${{ github.server_url }}/${{ github.repository }}
            org.opencontainers.image.revision=${{ github.sha }}

      - name: Build and push
        uses: docker/build-push-action@v6
        with:
          context: ./docker
          file: ${{ matrix.variant.dockerfile }}
          push: ${{ github.event_name != 'pull_request' }}
          platforms: |
            linux/amd64
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          secrets: |
            "admin_password=${{ secrets.CPS_JUPYTER_ADMIN_PASSWORD }}"
            "root_password=${{ secrets.CPS_JUPYTER_ROOT_PASSWORD }}"
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Generate Job Summary
        if: always()
        run: |
          echo "### Build Summary :rocket:" >> $GITHUB_STEP_SUMMARY
          echo "| Variant | Dockerfile | Tags |" >> $GITHUB_STEP_SUMMARY
          echo "| :--- | :--- | :--- |" >> $GITHUB_STEP_SUMMARY
          echo "| ${{ matrix.variant.name }} | ${{ matrix.variant.dockerfile }} | ${{ steps.meta.outputs.tags }} |" >> $GITHUB_STEP_SUMMARY
