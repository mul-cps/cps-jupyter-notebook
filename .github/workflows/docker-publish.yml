name: Build & Publish ML Variants

on:
  push:
    branches: [ main ]
    tags:
      - "v*.*.*"
  pull_request:
    branches: [ main ]

jobs:
  build-and-push:
    runs-on: ubuntu-latest

    permissions:
      contents: read
      packages: write
      id-token: write

    strategy:
      fail-fast: false
      matrix:
        variant:
          - name: pytorch-code
            dockerfile: docker/Dockerfile.pytorch-code
            suffix: pytorch-code
          - name: tf-code
            dockerfile: docker/Dockerfile.tf-code
            suffix: tf-code
          - name: desktop-ros2
            dockerfile: docker/Dockerfile.desktop-ros2
            suffix: desktop-ros2
          - name: comfyui
            dockerfile: docker/Dockerfile.comfyui
            suffix: comfyui
          - name: standard-cpu
            dockerfile: docker/Dockerfile
            suffix: standard-cpu
    env:
      IMAGE_NAME: cps-jupyter-notebook

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Free up disk space on runner
        run: |
          echo "Initial disk usage:"
          df -h

          echo "Removing large preinstalled SDKs..."
          sudo rm -rf /usr/local/lib/android || true
          sudo rm -rf /usr/share/dotnet || true
          sudo rm -rf /opt/ghc || true
          sudo rm -rf /opt/hostedtoolcache || true

          echo "Cleaning docker images and buildx cache..."
          docker system prune -af || true
          docker builder prune -af || true

          echo "Disk usage after cleanup:"
          df -h

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata (tags, labels)
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: |
            ghcr.io/${{ github.repository_owner }}/${{ env.IMAGE_NAME }}
          tags: |
            type=raw,value=latest-${{ matrix.variant.suffix }},enable=${{ startsWith(github.ref, 'refs/heads/main') }}
            type=ref,event=branch,suffix=-${{ matrix.variant.suffix }}
            type=ref,event=tag,suffix=-${{ matrix.variant.suffix }}
            type=sha,suffix=-${{ matrix.variant.suffix }}
          labels: |
            org.opencontainers.image.source=${{ github.server_url }}/${{ github.repository }}
            org.opencontainers.image.revision=${{ github.sha }}

      - name: Build and push
        uses: docker/build-push-action@v6
        with:
          context: ./docker
          file: ${{ matrix.variant.dockerfile }}
          push: ${{ github.event_name != 'pull_request' }}
          platforms: |
            linux/amd64
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          # If you want to build with secrets for admin/root passwords like the base images:
          secrets: |
            "admin_password=${{ secrets.CPS_JUPYTER_ADMIN_PASSWORD }}"
            "root_password=${{ secrets.CPS_JUPYTER_ROOT_PASSWORD }}"
